<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <meta property="og:site_name" content="Johan Rosa">
    <meta property="og:type" content="article">

    
    <meta property="og:image" content="//img/home_wave.jpg">
    <meta property="twitter:image" content="//img/home_wave.jpg" />
    

    
    <meta name="title" content="My first kaggle publication" />
    <meta property="og:title" content="My first kaggle publication" />
    <meta property="twitter:title" content="My first kaggle publication" />
    

    
    <meta name="description" content="Un Blog personal, algunas veces">
    <meta property="og:description" content="Un Blog personal, algunas veces" />
    <meta property="twitter:description" content="Un Blog personal, algunas veces" />
    

    
    <meta property="twitter:card" content="summary" />
    
    

    <meta name="keyword"  content="Johan Rosa, Rstats, R, Ciencia de datos, data science, dataviz">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>My first kaggle publication-Blog de Johan</title>

    <link rel="canonical" href="/post/my-first-kaggle-publication/">

    
    
    
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    
    <link rel="stylesheet" href="/css/hugo-theme-cleanwhite.min.css">

    
    <link rel="stylesheet" href="/css/zanshang.css">

    
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" rel="stylesheet" type="text/css">

    
    

    
    
    <script src="/js/jquery.min.js"></script>

    
    <script src="/js/bootstrap.min.js"></script>

    
    <script src="/js/hux-blog.min.js"></script>

    
    
    
    
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/docco.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <link rel="stylesheet" href="/css/docco.css" rel="stylesheet" id="theme-stylesheet">
    <script src="/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    
    

</head>




<nav class="navbar navbar-default navbar-custom navbar-fixed-top">

    <div class="container-fluid">
        
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Johan Rosa</a>
        </div>

        
        
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>
                    
                    
		    
                        <li><a href="/top/cv/">CV</a></li>
                    
                        <li><a href="/top/about/">Qui√©n soy</a></li>
                    
                        <li><a href="/top/archive/">Archivo</a></li>
                    

                    
                </ul>
            </div>
        </div>
        
    </div>
    
</nav>
<script>
    
    
    
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        
            $navbar.className = " ";
            
            setTimeout(function(){
                
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>




<style type="text/css">
    header.intro-header {
        background-image: url('/img/home_wave.jpg')
    }
</style>

<header class="intro-header" >

    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/r-markdown" title="R Markdown">
                            R Markdown
                        </a>
                        
                    </div>
                    <h1>My first kaggle publication</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
                        
                            Publicado por 
                            
                                Johan Rosa
                             
                            , 
                            2006-01-02
                            
                            
                            
                            
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>




<article>
    <div class="container">
        <div class="row">

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                
                
<script src="/rmarkdown-libs/header-attrs/header-attrs.js"></script>


<div id="exploratory-data-analysis-of-gas-prices-in-brazil" class="section level1">
<h1>Exploratory Data Analysis of Gas Prices in Brazil</h1>
<div id="intention" class="section level3">
<h3>Intention</h3>
<p>I have been a kaggle member since 2017 and the analysis that this community share every day have been a good source of learning material in my data science journey. This time I decide to stop been a reader and share with you my first notebook.</p>
<p>The main intention of the notebook is to make an Exploratory Data Analysis of the <strong>Gas Prices in Brazil</strong> data set, hoping that new r users and kagglers in general could use this as a useful material to learn and apply in their own analysis.</p>
<blockquote>
<p>English is not my native language, so, take this in consideration while reading my ideas.</p>
</blockquote>
</div>
<div id="introduction" class="section level3">
<h3>Introduction</h3>
<p>Brazil is the bigger oil producer in South America, and keeps a place between the top 10 producers in the world in 2018 (Source: Energy Information Administration). However, even the production level it has, the economy is not a net oil exporter, they have to import product to supply the national demand.</p>
<p>These facts makes oil prices in the country partially exposed to foreign shocks, that may be reflected in distortions in gas prices, with direct effects over the macroeconomic activity. Gas prices in any economy is an important variable correlated with the macroeconomic growth and general inflation levels.</p>
<p>This situation makes interesting an analysis of the evolution of gas prices in Brazil, using a data set with market prices and distribution prices of different product. In general, the analysis will cover a section oriented to import, transform and cleaning the data. Then, a data visualization exploration, finding trends, seasonality, distributions, etc.</p>
<p>The final topic will cover some modeling techniques, like exponential smoothing and least square to forecast the gas price evolution.</p>
</div>
<div id="packages" class="section level3">
<h3>Packages</h3>
<pre class="r"><code>library(janitor) # data cleaning and tables 
library(tidyverse) # metapackage with lots of helpful functions
library(lubridate) # to handle date objects in R
library(ggthemes) # themes for ggplot graphs
library(broom) # to handle models output in a tidy way
library(ggridges) # another tool to add elements to ggplot graphs </code></pre>
</div>
<div id="importing-and-cleanign-the-data-for-analysis" class="section level3">
<h3>Importing and cleanign the data for analysis</h3>
<p>This time the data comes in a <code>.tsv</code> format, which stands for Tab Separated Values. To import this type of text files the function <code>read_delim()</code> comes into play. This function, as the others in the <code>readr</code> package, has a better performance than their parallel in base <code>R</code> (<code>read.table</code> in this case) sice this provide a better automatic variable type identification, saving mutating code after importing the data.</p>
<p>run <code>gas2 &lt;- read.table("2004-2019.tsv", sep = "\t", header = TRUE)</code> an compare the results.</p>
<pre class="r"><code>gas &lt;- read_delim(&quot;data/2004-2019.tsv&quot;, delim = &quot;\t&quot;)</code></pre>
<p>Before showing the results of the data importing process, it is important to tune a bit the names of the variables in the <code>gas</code> data frame. This job was not automatic and consisted in writing by hand a short English translation of the names in Portuguese.</p>
<pre class="r"><code># This asignation structure helps when trying to sabe space in the cell

new_variables_names &lt;-  c(&quot;x&quot;, &quot;initial_date&quot;, &quot;end_date&quot;, &quot;region&quot;, &quot;state&quot;,
  &quot;product&quot;, &quot;stations_consulted&quot;,&quot;unit&quot;, &quot;mean_market_price&quot;,
  &quot;sd_market_price&quot;, &quot;min_market_price&quot;, &quot;max_market_price&quot;,
  &quot;mean_price_margin&quot;, &quot;cv_market_price&quot;, &quot;mean_distribution_price&quot;,
  &quot;sd_distribution_price&quot;, &quot;min_distribution_price&quot;,
  &quot;max_distribution_price&quot;, &quot;cv_distribution_price&quot;, &quot;month&quot;, &quot;year&quot;) 

names(gas) &lt;- new_variables_names

# I want a moth variable with labels, not only numbers
gas &lt;- gas %&gt;%
mutate(month_label = month(initial_date, label = TRUE))</code></pre>
<p>Done that, taking a glimpse of the data shows that all variables were import with a correct format. For example, dates were automatically parse as date.</p>
<pre class="r"><code>glimpse(gas)</code></pre>
<pre><code>## Rows: 106,823
## Columns: 22
## $ x                       &lt;dbl&gt; 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, ~
## $ initial_date            &lt;date&gt; 2004-05-09, 2004-05-09, 2004-05-09, 2004-05-0~
## $ end_date                &lt;date&gt; 2004-05-15, 2004-05-15, 2004-05-15, 2004-05-1~
## $ region                  &lt;chr&gt; &quot;CENTRO OESTE&quot;, &quot;CENTRO OESTE&quot;, &quot;CENTRO OESTE&quot;~
## $ state                   &lt;chr&gt; &quot;DISTRITO FEDERAL&quot;, &quot;GOIAS&quot;, &quot;MATO GROSSO&quot;, &quot;M~
## $ product                 &lt;chr&gt; &quot;ETANOL HIDRATADO&quot;, &quot;ETANOL HIDRATADO&quot;, &quot;ETANO~
## $ stations_consulted      &lt;dbl&gt; 127, 387, 192, 162, 103, 408, 278, 105, 125, 4~
## $ unit                    &lt;chr&gt; &quot;R$/l&quot;, &quot;R$/l&quot;, &quot;R$/l&quot;, &quot;R$/l&quot;, &quot;R$/l&quot;, &quot;R$/l&quot;~
## $ mean_market_price       &lt;dbl&gt; 1.288, 1.162, 1.389, 1.262, 1.181, 1.383, 1.45~
## $ sd_market_price         &lt;dbl&gt; 0.016, 0.114, 0.097, 0.070, 0.078, 0.132, 0.21~
## $ min_market_price        &lt;dbl&gt; 1.190, 0.890, 1.180, 1.090, 1.050, 0.999, 1.03~
## $ max_market_price        &lt;dbl&gt; 1.350, 1.449, 1.760, 1.509, 1.400, 2.050, 1.95~
## $ mean_price_margin       &lt;chr&gt; &quot;0.463&quot;, &quot;0.399&quot;, &quot;0.419&quot;, &quot;0.432&quot;, &quot;0.24&quot;, &quot;0~
## $ cv_market_price         &lt;dbl&gt; 0.012, 0.098, 0.070, 0.055, 0.066, 0.095, 0.15~
## $ mean_distribution_price &lt;chr&gt; &quot;0.825&quot;, &quot;0.763&quot;, &quot;0.97&quot;, &quot;0.83&quot;, &quot;0.941&quot;, &quot;0.~
## $ sd_distribution_price   &lt;chr&gt; &quot;0.11&quot;, &quot;0.088&quot;, &quot;0.095&quot;, &quot;0.119&quot;, &quot;0.077&quot;, &quot;0~
## $ min_distribution_price  &lt;chr&gt; &quot;0.4201&quot;, &quot;0.5013&quot;, &quot;0.5614&quot;, &quot;0.5991&quot;, &quot;0.744~
## $ max_distribution_price  &lt;chr&gt; &quot;0.9666&quot;, &quot;1.05&quot;, &quot;1.161&quot;, &quot;1.22242&quot;, &quot;1.0317&quot;~
## $ cv_distribution_price   &lt;chr&gt; &quot;0.133&quot;, &quot;0.115&quot;, &quot;0.098&quot;, &quot;0.143&quot;, &quot;0.082&quot;, &quot;~
## $ month                   &lt;chr&gt; &quot;05&quot;, &quot;05&quot;, &quot;05&quot;, &quot;05&quot;, &quot;05&quot;, &quot;05&quot;, &quot;05&quot;, &quot;05&quot;~
## $ year                    &lt;dbl&gt; 2004, 2004, 2004, 2004, 2004, 2004, 2004, 2004~
## $ month_label             &lt;ord&gt; May, May, May, May, May, May, May, May, May, M~</code></pre>
<p>Another useful translation would be to change the content of <code>region</code> and <code>product</code> variables. Changing the variable <code>state</code> is not an option here because these are given names.</p>
<pre class="r"><code>gas &lt;- gas %&gt;%
mutate(product = recode(product, &quot;ETANOL HIDRATADO&quot; = &quot;Hydrated Ethanol&quot;,
                       &quot;GASOLINA COMUM&quot; = &quot;Gasoline&quot;, &quot;GLP&quot; = &quot;LPG&quot;,
                       &quot;GNV&quot; = &quot;CNG&quot;, &quot;√ìLEO DIESEL&quot; = &quot;Diesel Oil&quot;, 
                       &quot;√ìLEO DIESEL S10&quot; = &quot;Diesel S10&quot;),
      region = recode(region, &#39;CENTRO OESTE&#39; = &#39;West Center&#39;,
                      &#39;NORDESTE&#39; = &#39;Northeast&#39;, &#39;NORTE&#39; = &#39;North&#39;,
                      &#39;SUDESTE&#39; = &#39;SouthEast&#39;, &#39;SUL&#39; = &#39;South&#39;),
      floor_date = floor_date(initial_date, &quot;month&quot;))</code></pre>
</div>
<div id="data-visualisation" class="section level3">
<h3>Data visualisation</h3>
<p>In general, gas prices in Brazil have shown an upward trend as the one observe in the global oil market in the last decade. On average, the mean market price of all type of gas in Brazil changed in a rate of 6% yearly. The Compressed Natural Gas was the fuel with the higher variation (7.3% every year, on average).</p>
<div id="table-1-market-prices-variation" class="section level4">
<h4>Table 1: Market prices variation</h4>
<pre class="r"><code># Code for the task
gas %&gt;%
group_by(year, product) %&gt;%
summarise(mean_price = mean(mean_market_price, na.rm = TRUE)) %&gt;%
group_by(product) %&gt;%
mutate(lag = lag(mean_price), 
      variation = ((mean_price - lag)/ lag)*100) %&gt;%
select(-mean_price, -lag) %&gt;%
mutate_if(is.numeric, round, digit = 2) %&gt;%
spread(product, variation)</code></pre>
<pre><code>## # A tibble: 16 x 7
##     year   CNG `Diesel Oil` `Diesel S10` Gasoline `Hydrated Ethanol`   LPG
##    &lt;dbl&gt; &lt;dbl&gt;        &lt;dbl&gt;        &lt;dbl&gt;    &lt;dbl&gt;              &lt;dbl&gt; &lt;dbl&gt;
##  1  2004 NA           NA           NA       NA                 NA    NA   
##  2  2005  7.59        14.3         NA        8.85              11.3  -1.52
##  3  2006 11.7          8.07        NA        8.93              15.7   6.15
##  4  2007  7.12        -0.6         NA       -1.96             -11.0   2.18
##  5  2008 12.7          8.42        NA        0.09               1.16  0.67
##  6  2009  3.57         1.46        NA        0.28               0.03  5.51
##  7  2010 -1.01        -2.27        NA        1.89               9.25  5.72
##  8  2011  0.56         1.04        NA        4.5               13.8   1.36
##  9  2012  4.76         2.48        NA        0.07               1.03  2.3 
## 10  2013  4.71        10.9         11.4      4.76               3.95  5.65
## 11  2014  5.32         8.23         8.48     4.07               5.63  6.05
## 12  2015  9.71        12.9         12.4     12.7                7.23 12.6 
## 13  2016  9.36         7.53         6.9      9.58              19.2  11.9 
## 14  2017  3.78         2.87         2.47     1.75               1.71  9.26
## 15  2018 15.3         12.1         10.7     16.5                7.81 15.4 
## 16  2019 14.4          2.05         1.72    -1.05               1.09  1.3</code></pre>
<p>The evolution of prices in all regions was not equal, even though the general trend for all was positive. The regional disaggregation shows that prices in the North region had the higher volatility, especially over CNG prices.</p>
<p>Another aspect is that prices in West Center and North regions are over the prices in the others. This element demand a comparison between selling margins in the diferent areas, to see if prices in these regions are higher because of a higher margin or due to cost structure.</p>
</div>
<div id="plot-1.-evolution-of-gas-prices-by-product-and-region" class="section level4">
<h4>Plot 1. Evolution of gas prices by product and region</h4>
<pre class="r"><code># Code for this task
gas %&gt;%
group_by(year, month, initial_date, region, product) %&gt;%
summarise(mean_market_price = mean(mean_market_price, na.rm = TRUE)) %&gt;%
ggplot(aes(x = initial_date, y = mean_market_price, color = region)) +
geom_line() +
facet_wrap(~product, scale = &quot;free&quot;) +
theme(legend.position = &quot;bottom&quot;) +
scale_colour_hue(l = 40, c = 30) +
ggthemes::theme_fivethirtyeight() +
labs(y = &quot;US$&quot;)</code></pre>
<pre><code>## `summarise()` has grouped output by &#39;year&#39;, &#39;month&#39;, &#39;initial_date&#39;, &#39;region&#39;.
## You can override using the `.groups` argument.</code></pre>
<p><img src="/post/2019-08-02-my-first-kaggle-publication_files/figure-html/unnamed-chunk-4-1.png" width="672" /></p>
</div>
</div>
<div id="margins-distributions-by-region-and-product" class="section level3">
<h3>Margins distributions by region and product</h3>
<ul>
<li>Camparign margins in all regions shows that CNG has the higher one.</li>
</ul>
<pre class="r"><code>gas %&gt;%
#group_by(year, month, floor_date, region, product) %&gt;%
#summarise(mean_market_price = mean(mean_market_price, na.rm = TRUE)) %&gt;%
filter(!product == &quot;LPG&quot;) %&gt;%
ggplot(aes(x = mean_price_margin, fill = product, color = product)) +
geom_density(alpha = 0.15) +
scale_colour_hue(l = 40, c = 30) +
facet_wrap(~region, scales = &quot;free_y&quot;) +
theme(legend.position = &quot;bottom&quot;) +
theme_fivethirtyeight()</code></pre>
<p><img src="/post/2019-08-02-my-first-kaggle-publication_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
<pre class="r"><code>#coord_flip()</code></pre>
</div>
<div id="seassonality" class="section level3">
<h3>Seassonality</h3>
<p>This type of data with monthly frequency usually brings seasonal patterns that are important to be detect. In this case, we are going to explore seasonality with a graph. This graph in particular shows a line for each year, where months are map to one of the axis, allowing us to see is a cycle repeat over the different lines.</p>
<p>In general, there is not a clear cycle in the different variables, but anyway two things can be Highlighted.</p>
<ul>
<li><ol style="list-style-type: decimal">
<li>Diesel prices tend to increase more rapidly in the last quarter of the year.</li>
</ol></li>
<li><ol start="2" style="list-style-type: decimal">
<li>Hydrated Ethanol prices tend to increase more rapidly in the first quarter of the year.</li>
</ol></li>
</ul>
<div id="plot-3.-seassonal-plot" class="section level4">
<h4>Plot 3. Seassonal plot</h4>
<pre class="r"><code>gas %&gt;%
group_by(year, month_label,  product) %&gt;%
summarise(mean_market_price = mean(mean_market_price, na.rm = TRUE)) %&gt;%
ggplot(aes(x = month_label, y = mean_market_price, color = year, group = year)) + 
geom_line() +
facet_wrap(~product, scales = &quot;free&quot;) +
theme_fivethirtyeight() +
theme(legend.position = &quot;bottom&quot;,
     axis.text.x = element_text(angle = 90, size = 9), 
     panel.grid = element_blank(),
     legend.text = element_text(size = 7))</code></pre>
<pre><code>## `summarise()` has grouped output by &#39;year&#39;, &#39;month_label&#39;. You can override
## using the `.groups` argument.</code></pre>
<p><img src="/post/2019-08-02-my-first-kaggle-publication_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
</div>
</div>
<div id="trend-and-slope-of-the-evolution" class="section level3">
<h3>Trend and slope of the evolution</h3>
<p>Since the beginning of the notebook the existence of a positive trend in the evolution of the prices was mention in different parts, but now it is time to describe that trend and with a linear regression explore the slope by fuel in each region.</p>
<p>Previously, a line plot of mean market price was shown, where the mean appear without any element related to the dispersion of the different prices. This time a hexagonal plot shows the trend that we mention before, isolated by different facets. A hex plot was use because it is easier to show the concentration and distribution of the prices than using points with low opacity.</p>
<p>With this analysis emerged a few insights:</p>
<ul>
<li>The Ethanol was the fuel with the lower slope and higher variance</li>
<li>Diesel S10 was the one with the higher variation.</li>
<li>Compressed Natural Gas has a low share in the north region. In addition, there are some states in this region that bought CNG different moments but it have not been adopt as a frequent source of energy.</li>
<li>In the West Center region, the price of Liquefied petroleum gas (LPG) has a clear variation by state, evidence in the different branches of the hexagons. I did not include color by state in this visualization, but I did the homework and a different trend within the region explains those branches.</li>
</ul>
<pre class="r"><code>gas %&gt;%
    ggplot(aes(x = initial_date, y = mean_market_price)) +
    geom_hex(show.legend = F) +
    #geom_point(alpha = 0.09, size = 0.1) +
    facet_grid(product~region, scales = &quot;free&quot;) +
    theme(legend.position = &quot;none&quot;) +
    theme_fivethirtyeight() +
    theme( axis.text.x = element_text(angle = 90))</code></pre>
<pre><code>## Warning: Computation failed in `stat_binhex()`:
## 
## Computation failed in `stat_binhex()`:
## 
## Computation failed in `stat_binhex()`:
## 
## Computation failed in `stat_binhex()`:
## 
## Computation failed in `stat_binhex()`:
## 
## Computation failed in `stat_binhex()`:
## 
## Computation failed in `stat_binhex()`:
## 
## Computation failed in `stat_binhex()`:
## 
## Computation failed in `stat_binhex()`:
## 
## Computation failed in `stat_binhex()`:
## 
## Computation failed in `stat_binhex()`:
## 
## Computation failed in `stat_binhex()`:
## 
## Computation failed in `stat_binhex()`:
## 
## Computation failed in `stat_binhex()`:
## 
## Computation failed in `stat_binhex()`:
## 
## Computation failed in `stat_binhex()`:
## 
## Computation failed in `stat_binhex()`:
## 
## Computation failed in `stat_binhex()`:
## 
## Computation failed in `stat_binhex()`:
## 
## Computation failed in `stat_binhex()`:
## 
## Computation failed in `stat_binhex()`:
## 
## Computation failed in `stat_binhex()`:
## 
## Computation failed in `stat_binhex()`:
## 
## Computation failed in `stat_binhex()`:
## 
## Computation failed in `stat_binhex()`:
## 
## Computation failed in `stat_binhex()`:
## 
## Computation failed in `stat_binhex()`:
## 
## Computation failed in `stat_binhex()`:
## 
## Computation failed in `stat_binhex()`:
## 
## Computation failed in `stat_binhex()`:</code></pre>
<p><img src="/post/2019-08-02-my-first-kaggle-publication_files/figure-html/unnamed-chunk-7-1.png" width="672" /></p>
<p>Now I will apply an approach from book ‚ÄúR for Data Science‚Äù, in order to run many models at once for each strata. The strategy to accomplish this is to nest the data with <code>tidyr</code>, ending with a data frame of data frames called <code>by_region_product</code>, then mutating each DF to end with a model.</p>
<p>Having the models we can extract information about the coefficients (standar error, p.values) and about the individual observations (residuals).</p>
<pre class="r"><code># Using nest function from tidyr to create a data set of data set with the diferent strata 
by_region_product &lt;- gas %&gt;%
mutate(period_change = as.numeric(round((min(initial_date) - initial_date)/30, 0)) * -1) %&gt;%
group_by(region, product) %&gt;%
nest()

# adding a linear model and some summary statistics about them
by_region_product &lt;- by_region_product %&gt;%
mutate(price_lm = map(data, ~lm(mean_market_price ~ period_change, data = .x)),
      glance = map(price_lm, glance),
      tidy = map(price_lm, tidy),
      augment = map(price_lm, augment),
      rsq = map_dbl(glance, &quot;r.squared&quot;))

# Plot of the slopes colored by the fit indicador Rsquared
by_region_product %&gt;%
unnest(tidy) %&gt;% 
select(region, product, rsq, term, estimate) %&gt;%
  spread(term, estimate) %&gt;%
rename(intercept = `(Intercept)`) %&gt;%
filter(!product == &quot;LPG&quot;) %&gt;%
mutate(producto = factor(product),
      producto = fct_reorder(product, rsq)) %&gt;%
ggplot(aes(y = product, x = period_change, color = rsq)) +
geom_point() +
facet_wrap(~region, scale = &quot;free_x&quot;) +
theme_fivethirtyeight() +
theme(legend.position = &quot;bottom&quot;,
     axis.text = element_text(size = 8),
     legend.text = element_text(size = 8)) </code></pre>
<p><img src="/post/2019-08-02-my-first-kaggle-publication_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
</div>
</div>


                

                <hr>
                <ul class="pager">
                    
                    
                    <li class="next">
                        <a href="/post/creando-mapas-de-rep%C3%BAblica-dominicana-en-r/" data-toggle="tooltip" data-placement="top" title="Creando Mapas de Rep√∫blica Dominicana en R">Next
                            Post &rarr;</a>
                    </li>
                    
                </ul>
                

<div id="disqus-comment"></div>
<div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "johan-blog" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


            </div>

            

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                
                

                
    <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
    
    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"] ],
            displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
            processEscapes: true,
            processEnvironments: true
        },
        // Center justify equations in code and markdown cells. Elsewhere
        // we use CSS to left justify single line equations in code cells.
        displayAlign: 'center',
        "HTML-CSS": {
            styles: {'.MathJax_Display': {"margin": 0}},
            linebreaks: { automatic: true }
        }
    });
    </script>
    

                
                
                <section>
                    <hr>
                    <h5>FRIENDS</h5>
                    <ul class="list-inline">
                        
                        <li><a target="_blank" href="http://betaeconomia.blogspot.com/">Nerys Ram√≠rez</a></li>
                        
                    </ul>
                </section>
                
            </div>
        </div>
    </div>
</article>




<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                   
                    
                    <li>
                        <a href="mailto:johan.rosaperez@gmail.com">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		    

                    
                    
                    

                    

		    
                    
                    
                    <li>
                        <a target="_blank" href="https://github.com/johan-rosa">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		    
                    
                    
                    
                    <li>
                        <a target="_blank" href="https://www.linkedin.com/in/johan-rosa-72bb0484/">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		    
                    
                    
                    <li>
                        <a target="_blank" href="https://stackoverflow.com/users/10266675/johan-rosa">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-stack-overflow fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
            
                    
                    
                    
            
            
            
                </ul>
		<p class="copyright text-muted">
                    Copyright &copy; Johan Rosa 2022
                    <br>
                    <a href="https://themes.gohugo.io/hugo-theme-cleanwhite">CleanWhite Hugo Theme</a> by <a href="https://zhaohuabing.com">Huabing</a> |
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="100px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=zhaohuabing&repo=hugo-theme-cleanwhite&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>




<script>
    function loadAsync(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>






<script>
    
    if($('#tag_cloud').length !== 0){
        loadAsync("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>


<script>
    loadAsync("https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>






<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-151896571-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>






<script type="text/javascript">
    function generateCatalog(selector) {

        
        
        
        
            _containerSelector = 'div.post-container'
        

        
        var P = $(_containerSelector), a, n, t, l, i, c;
        a = P.find('h1,h2,h3,h4,h5,h6');

        
        $(selector).html('')

        
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#" + $(this).prop('id');
            t = $(this).text();
            c = $('<a href="' + i + '" rel="nofollow">' + t + '</a>');
            l = $('<li class="' + n + '_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    
    $(".catalog-toggle").click((function (e) {
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    


    loadAsync("\/js\/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>


</body>
</html>
